<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CR-04 Платіжний виняток — UIUX PoC</title>
  <link rel="stylesheet" href="../../../assets/css/styles.css">
</head>
<body>
  <header class="page-header" role="banner">
    <h1>CR-04 Платіжний виняток</h1>
    <p style="margin:0; color: var(--text-secondary); font-size: 13px;">Часткова оплата або розбіжність оплати перед видачею</p>
  </header>

  <main class="page-main" role="main">
    <section class="hero-notice" aria-label="Головний контекст сторінки">
      <p class="notice-title">hero-notice: Платіжний виняток</p>
      <p><strong>Для фінансиста, менеджера, складу.</strong> Сценарій часткової оплати або розбіжності перед видачею. Видача заблокована до вирішення.</p>
      <p><strong>Раніше (AS-IS):</strong> стан оплати перевірявся в 1С вручну. Якщо оплата часткова — фінансист повідомляв менеджера листом, менеджер зв'язувався з клієнтом. Склад чекав усного підтвердження. Override (видача без повної оплати) — без формального запису.</p>
      <p><strong>Тепер у F1 (TO-BE):</strong> розбивка очікуваного vs отриманого видима в панелі шлюзу. Рішення gate (pass/fail) блокує або дозволяє видачу системно. Override FAIL→PASS вимагає PAYMENT_GATE_OVERRIDE_APPROVAL з deep-верифікацією. Кожне рішення — в аудиторському записі з актором/часом/причиною. Склад читає gate-статус напряму без дублюючого каналу (TC-FIN-02).</p>
    </section>

    <section class="section" aria-labelledby="gate-title">
      <h2 id="gate-title">Панель шлюзу — Очікувана vs Отримана оплата</h2>

      <div class="hero-notice">
        <p class="notice-title">hero-notice: Панель шлюзу</p>
        <p>Фінансист фіксує платіжний виняток; оцінювач шлюзу встановлює FAIL; склад бачить блокер видачі.</p>
      </div>
      <script type="application/json" id="mock-gate">
        {
          "meta": { "source": "dummy", "version": "poc", "contract_id": "CR-04_payment_exception_flow" },
          "data": {
            "expected_amount": 12500.00,
            "paid_amount": 10000.00,
            "shortfall": 2500.00,
            "gate_status": "fail",
            "release_blocked": true,
            "override_available": true
          },
          "errors": []
        }
      </script>

      <div class="card" id="gate-card"></div>
    </section>

    <section class="section" aria-labelledby="gate-timeline-title">
      <h2 id="gate-timeline-title">Хронологія рішень шлюзу</h2>

      <div class="hero-notice">
        <p class="notice-title">hero-notice: Хронологія рішень шлюзу</p>
        <p>Історія рішень по шлюзу та override.</p>
      </div>
      <script type="application/json" id="mock-gate-timeline">
        {
          "meta": { "source": "dummy", "version": "poc" },
          "data": {
            "items": [
              { "actor": "finance_user", "timestamp": "2024-02-10T11:00:00Z", "event": "gate_evaluated", "delta": "FAIL: shortfall 2500" },
              { "actor": "finance_user", "timestamp": "2024-02-10T10:30:00Z", "event": "payment_exception_registered", "delta": "partial payment detected" },
              { "actor": "warehouse_system", "timestamp": "2024-02-10T11:05:00Z", "event": "release_blocker_set", "delta": "blocked by gate" }
            ]
          },
          "errors": []
        }
      </script>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Виконавець</th><th>Час</th><th>Подія</th><th>Зміна</th></tr>
          </thead>
          <tbody id="gate-timeline-tbody"></tbody>
        </table>
      </div>
    </section>

    <section class="section" aria-labelledby="override-title">
      <h2 id="override-title">Аудит override</h2>

      <div class="hero-notice">
        <p class="notice-title">hero-notice: Аудит override</p>
        <p>Потік override з обов'язковою причиною та нотифікацією складу.</p>
      </div>
      <script type="application/json" id="mock-override-audit">
        {
          "meta": { "source": "dummy", "version": "poc" },
          "data": {
            "items": [],
            "message": "Аудит override: запис з'явиться після override з reason_code"
          },
          "errors": []
        }
      </script>

      <div class="card" id="override-card"></div>
    </section>

    <section class="section" aria-labelledby="approval-overlay-title">
      <h2 id="approval-overlay-title">Шлюз затвердження</h2>

      <div class="hero-notice">
        <p class="notice-title">hero-notice: PAYMENT_GATE_OVERRIDE_APPROVAL</p>
        <p>Будь-який manual FAIL → PASS проходить через PAYMENT_GATE_OVERRIDE_APPROVAL (Керівник фінансів, deep verify). Gate = PASS тільки після підтвердженої повної оплати або формально затвердженого override.</p>
      </div>
      <script type="application/json" id="mock-approval-overlay">
        {
          "meta": { "source": "dummy", "version": "poc" },
          "data": {
            "approvals": [
              { "action": "Ручне перемикання FAIL → PASS", "approval_type": "PAYMENT_GATE_OVERRIDE_APPROVAL", "approver_role": "FINANCE_LEAD", "decision_status": "pending", "verification_mode": "deep", "sla_minutes": 15 }
            ]
          },
          "errors": []
        }
      </script>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>Дія</th><th>Тип рішення</th><th>Роль-затверджувач</th><th>Статус рішення</th><th>Верифікація</th><th>SLA</th></tr>
          </thead>
          <tbody id="approval-overlay-tbody"></tbody>
        </table>
      </div>
    </section>

    <nav style="margin-top: 2rem;">
      <a href="../../../index.html" class="btn btn-secondary">← До індексу</a>
    </nav>
  </main>

  <script src="../../../assets/js/mock-render.js"></script>
  <script>
    (function() {
      // ── UA label maps ──
      var gateLabels = { pass: 'ДОЗВІЛ', fail: 'БЛОКУВАННЯ' };
      var roleLabels = { finance_user: 'Фінансист', warehouse_system: 'Система (Склад)', system: 'Система', FINANCE_LEAD: 'Керівник фінансів', FINANCE: 'Фінанси' };

      var gate = window.MockRender.getMock("mock-gate");
      var card = document.getElementById("gate-card");
      if (card && gate.data) {
        var d = gate.data;
        var gateClass = d.gate_status === "pass" ? "pass" : "fail";
        card.innerHTML = "<p><strong>Очікувана сума:</strong> " + d.expected_amount + " | <strong>Отримано:</strong> " + d.paid_amount + "</p>" +
          "<p><strong>Недоплата:</strong> " + d.shortfall + "</p>" +
          "<p><strong>Шлюз:</strong> <span class=\"gate-badge " + gateClass + "\">" + (gateLabels[d.gate_status] || d.gate_status) + "</span></p>" +
          "<p><strong>Видачу заблоковано:</strong> " + (d.release_blocked ? "так" : "ні") + "</p>" +
          "<p><strong>Override доступний:</strong> " + (d.override_available ? "так" : "ні") + "</p>";
      }

      var tl = window.MockRender.getMock("mock-gate-timeline");
      var tbody = document.getElementById("gate-timeline-tbody");
      if (tbody && tl.data && tl.data.items) {
        tbody.innerHTML = tl.data.items.map(function(i) {
          return "<tr><td>" + (roleLabels[i.actor] || i.actor) + "</td><td>" + i.timestamp + "</td><td>" + i.event + "</td><td>" + i.delta + "</td></tr>";
        }).join("");
      }

      var ov = window.MockRender.getMock("mock-override-audit");
      var ovCard = document.getElementById("override-card");
      if (ovCard && ov.data) {
        ovCard.innerHTML = "<p>" + ov.data.message + "</p>";
        if (ov.data.items && ov.data.items.length) {
          ovCard.innerHTML += "<ul>" + ov.data.items.map(function(i) {
            return "<li>" + (roleLabels[i.actor] || i.actor) + " @ " + i.timestamp + ": " + i.reason_code + "</li>";
          }).join("") + "</ul>";
        }
      }

      // ── Approval Overlay ──
      var approvalTypeLabels = { PAYMENT_GATE_OVERRIDE_APPROVAL: 'Override платіжного шлюзу' };
      var decisionStatusLabels = { pending: 'В очікуванні', approved: 'Затверджено', rejected: 'Відхилено' };
      var verificationLabels = { standard: 'Стандартна', deep: 'Поглиблена' };
      var ao = window.MockRender.getMock("mock-approval-overlay");
      var aoTbody = document.getElementById("approval-overlay-tbody");
      if (aoTbody && ao.data && ao.data.approvals) {
        aoTbody.innerHTML = ao.data.approvals.map(function(a) {
          return "<tr><td>" + a.action + "</td><td>" + (approvalTypeLabels[a.approval_type] || a.approval_type) + "</td><td>" + (roleLabels[a.approver_role] || a.approver_role) + "</td><td>" + (decisionStatusLabels[a.decision_status] || a.decision_status) + "</td><td>" + (verificationLabels[a.verification_mode] || a.verification_mode) + "</td><td>" + a.sla_minutes + " хв</td></tr>";
        }).join("");
      }
    })();
  </script>
</body>
</html>
